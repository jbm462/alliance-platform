"use strict";(()=>{var e={};e.id=277,e.ids=[277],e.modules={1649:e=>{e.exports=require("next-auth/react")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2079:e=>{e.exports=import("openai")},6555:e=>{e.exports=import("uuid")},4164:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>c,default:()=>u,routeModule:()=>d});var r=s(1802),i=s(7153),n=s(6249),o=s(9384),l=e([o]);o=(l.then?(await l)():l)[0];let u=(0,n.l)(o,"default"),c=(0,n.l)(o,"config"),d=new r.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/workflow-instances/[id]",pathname:"/api/workflow-instances/[id]",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},6357:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.d(t,{We:()=>executeAIStep});var r=s(2079),i=e([r]);r=(i.then?(await i)():i)[0];let n=process.env.OPENAI_API_KEY;if(!n)throw Error("Missing OpenAI API key");new r.default({apiKey:n});let interpolateInputs=(e,t)=>{let s=e;return Object.entries(t).forEach(([e,t])=>{let a=`{{${e}}}`,r="";r="object"==typeof t?JSON.stringify(t,null,2):String(t),s=s.replace(RegExp(a,"g"),r)}),s};async function executeAIStep(e,t){let s=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:e.systemPrompt||"You are a helpful assistant."},{role:"user",content:interpolateInputs(e.userPrompt||"",t)}],max_tokens:2e3,temperature:.7})}),a=await s.json(),r=a.usage.total_tokens;return{content:a.choices[0].message.content,cost:r/1e3*.002,tokens:r}}a()}catch(e){a(e)}})},4217:(e,t,s)=>{s.d(t,{O:()=>n});let a=require("@supabase/supabase-js"),r="https://rpudkaqdoguytyweytww.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdWRrYXFkb2d1eXR5d2V5dHd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNDI3NTMsImV4cCI6MjA2MzcxODc1M30.GWu-jUQXMU94kTuGx9aK5aG_xNVjJFq9lbrcLUW8HBA";if(!r||!i)throw Error("Missing Supabase environment variables");let n=(0,a.createClient)(r,i,{auth:{persistSession:!1,autoRefreshToken:!1},global:{fetch:fetch}})},9384:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{default:()=>handler});var r=s(4217),i=s(1649),n=s(6357),o=s(6555),l=e([n,o]);async function handler(e,t){let{id:s}=e.query,a=await (0,i.getSession)({req:e});if(!a)return t.status(401).json({message:"Unauthorized"});if("GET"===e.method)try{let{data:e,error:a}=await r.O.from("workflow_instances").select(`
          *,
          workflow:workflows(
            *,
            steps:workflow_steps(*)
          ),
          step_executions(*)
        `).eq("id",s).single();if(a){if("PGRST116"===a.code)return t.status(404).json({message:"Workflow instance not found"});throw a}return t.status(200).json(e)}catch(e){return console.error("Error fetching workflow instance:",e),t.status(500).json({message:"Failed to fetch workflow instance"})}if("PUT"===e.method)try{let{currentStepIndex:a,status:i,humanTimeSpent:n,clientWaitTime:o,outputQualityScore:l,completedAt:u}=e.body,c={};if(void 0!==a&&(c.current_step_index=a),i&&(c.status=i),n){let{data:e}=await r.O.from("workflow_instances").select("human_time_spent_ms").eq("id",s).single();c.human_time_spent_ms=(e?.human_time_spent_ms||0)+n}if(o){let{data:e}=await r.O.from("workflow_instances").select("client_wait_time_ms").eq("id",s).single();c.client_wait_time_ms=(e?.client_wait_time_ms||0)+o}if(void 0!==l&&(c.output_quality_score=l),u){c.completed_at=u;let{data:e}=await r.O.from("workflow_instances").select("started_at").eq("id",s).single();if(e?.started_at){let t=new Date(e.started_at).getTime(),s=new Date(u).getTime();c.total_execution_time_ms=s-t}}let{error:d}=await r.O.from("workflow_instances").update(c).eq("id",s);if(d)throw d;let{data:p,error:m}=await r.O.from("workflow_instances").select(`
          *,
          workflow:workflows(
            *,
            steps:workflow_steps(*)
          ),
          step_executions(*)
        `).eq("id",s).single();if(m)throw m;return t.status(200).json(p)}catch(e){return console.error("Error updating workflow instance:",e),t.status(500).json({message:"Failed to update workflow instance"})}if("POST"===e.method)try{let{stepId:a,stepType:i,inputs:l}=e.body;if(!a||!i)return t.status(400).json({message:"Step ID and type are required"});let{data:u,error:c}=await r.O.from("workflow_steps").select("*").eq("id",a).single();if(c)return t.status(404).json({message:"Step not found"});if("ai"===i){let e=Date.now();try{let s=await (0,n.We)(u,l||{}),a=Date.now();return t.status(200).json({output:s,executionTime:a-e})}catch(e){return console.error("Error executing AI step:",e),t.status(500).json({message:"AI step execution failed"})}}if("human"===i){let{output:i,executionTime:n}=e.body;if(!i)return t.status(400).json({message:"Output is required for human steps"});let o=new Date().toISOString(),{error:u}=await r.O.from("step_executions").insert({instance_id:s,step_id:a,started_at:o,completed_at:o,status:"completed",execution_time_ms:n||0,output:i,input_data:l||{}});if(u)throw u;if(n){let{data:e}=await r.O.from("workflow_instances").select("human_time_spent_ms").eq("id",s).single(),t=e?.human_time_spent_ms||0;await r.O.from("workflow_instances").update({human_time_spent_ms:t+n}).eq("id",s)}return t.status(200).json({output:i,executionTime:n||0})}if("client_validate"===i){let{clientEmail:i}=e.body;if(!i)return t.status(400).json({message:"Client email is required for validation steps"});let n=(0,o.v4)(),l=new Date().toISOString(),u=new Date;u.setDate(u.getDate()+7);let c=`${process.env.NEXT_PUBLIC_APP_URL}/client-validation/${n}`,{error:d}=await r.O.from("client_validations").insert({id:n,instance_id:s,step_id:a,created_at:l,expires_at:u.toISOString(),status:"pending",secure_link:c});if(d)throw d;return t.status(200).json({message:"Client validation initiated",secureLink:c})}return t.status(400).json({message:"Unsupported step type"})}catch(e){return console.error("Error executing step:",e),t.status(500).json({message:"Failed to execute step"})}return t.status(405).json({message:"Method not allowed"})}[n,o]=l.then?(await l)():l,a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[222],()=>__webpack_exec__(4164));module.exports=s})();