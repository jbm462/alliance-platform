"use strict";(()=>{var e={};e.id=277,e.ids=[277],e.modules={1649:e=>{e.exports=require("next-auth/react")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2079:e=>{e.exports=import("openai")},6555:e=>{e.exports=import("uuid")},4164:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>d,default:()=>l,routeModule:()=>c});var i=s(1802),r=s(7153),n=s(6249),o=s(9384),u=e([o]);o=(u.then?(await u)():u)[0];let l=(0,n.l)(o,"default"),d=(0,n.l)(o,"config"),c=new i.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/workflow-instances/[id]",pathname:"/api/workflow-instances/[id]",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},4217:(e,t,s)=>{s.d(t,{O:()=>n});let a=require("@supabase/supabase-js"),i="https://rpudkaqdoguytyweytww.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdWRrYXFkb2d1eXR5d2V5dHd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNDI3NTMsImV4cCI6MjA2MzcxODc1M30.GWu-jUQXMU94kTuGx9aK5aG_xNVjJFq9lbrcLUW8HBA";if(!i||!r)throw Error("Missing Supabase environment variables");let n=(0,a.createClient)(i,r,{auth:{persistSession:!1,autoRefreshToken:!1},global:{fetch:fetch}})},9384:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{default:()=>handler});var i=s(4217),r=s(1649),n=s(6357),o=s(6555),u=e([n,o]);async function handler(e,t){let{id:s}=e.query,a=await (0,r.getSession)({req:e});if(!a)return t.status(401).json({message:"Unauthorized"});if("GET"===e.method)try{let{data:e,error:a}=await i.O.from("workflow_instances").select(`
          *,
          workflow:workflows(
            *,
            steps:workflow_steps(*)
          ),
          step_executions(*)
        `).eq("id",s).single();if(a){if("PGRST116"===a.code)return t.status(404).json({message:"Workflow instance not found"});throw a}return t.status(200).json(e)}catch(e){return console.error("Error fetching workflow instance:",e),t.status(500).json({message:"Failed to fetch workflow instance"})}if("PUT"===e.method)try{let{currentStepIndex:a,status:r,humanTimeSpent:n,clientWaitTime:o,outputQualityScore:u,completedAt:l}=e.body,d={};if(void 0!==a&&(d.current_step_index=a),r&&(d.status=r),n){let{data:e}=await i.O.from("workflow_instances").select("human_time_spent_ms").eq("id",s).single();d.human_time_spent_ms=(e?.human_time_spent_ms||0)+n}if(o){let{data:e}=await i.O.from("workflow_instances").select("client_wait_time_ms").eq("id",s).single();d.client_wait_time_ms=(e?.client_wait_time_ms||0)+o}if(void 0!==u&&(d.output_quality_score=u),l){d.completed_at=l;let{data:e}=await i.O.from("workflow_instances").select("started_at").eq("id",s).single();if(e?.started_at){let t=new Date(e.started_at).getTime(),s=new Date(l).getTime();d.total_execution_time_ms=s-t}}let{error:c}=await i.O.from("workflow_instances").update(d).eq("id",s);if(c)throw c;let{data:w,error:_}=await i.O.from("workflow_instances").select(`
          *,
          workflow:workflows(
            *,
            steps:workflow_steps(*)
          ),
          step_executions(*)
        `).eq("id",s).single();if(_)throw _;return t.status(200).json(w)}catch(e){return console.error("Error updating workflow instance:",e),t.status(500).json({message:"Failed to update workflow instance"})}if("POST"===e.method)try{let{stepId:a,stepType:r,inputs:u}=e.body;if(!a||!r)return t.status(400).json({message:"Step ID and type are required"});let{data:l,error:d}=await i.O.from("workflow_steps").select("*").eq("id",a).single();if(d)return t.status(404).json({message:"Step not found"});if("ai"===r){let e=Date.now();try{let s=await (0,n.We)(l,u||{}),a=Date.now();return t.status(200).json({output:s,executionTime:a-e})}catch(e){return console.error("Error executing AI step:",e),t.status(500).json({message:"AI step execution failed"})}}if("human"===r){let{output:r,executionTime:n}=e.body;if(!r)return t.status(400).json({message:"Output is required for human steps"});let o=new Date().toISOString(),{error:l}=await i.O.from("step_executions").insert({instance_id:s,step_id:a,started_at:o,completed_at:o,status:"completed",execution_time_ms:n||0,output:r,input_data:u||{}});if(l)throw l;if(n){let{data:e}=await i.O.from("workflow_instances").select("human_time_spent_ms").eq("id",s).single(),t=e?.human_time_spent_ms||0;await i.O.from("workflow_instances").update({human_time_spent_ms:t+n}).eq("id",s)}return t.status(200).json({output:r,executionTime:n||0})}if("client_validate"===r){let{clientEmail:r}=e.body;if(!r)return t.status(400).json({message:"Client email is required for validation steps"});let n=(0,o.v4)(),u=new Date().toISOString(),l=new Date;l.setDate(l.getDate()+7);let d=`${process.env.NEXT_PUBLIC_APP_URL}/client-validation/${n}`,{error:c}=await i.O.from("client_validations").insert({id:n,instance_id:s,step_id:a,created_at:u,expires_at:l.toISOString(),status:"pending",secure_link:d});if(c)throw c;return t.status(200).json({message:"Client validation initiated",secureLink:d})}return t.status(400).json({message:"Unsupported step type"})}catch(e){return console.error("Error executing step:",e),t.status(500).json({message:"Failed to execute step"})}return t.status(405).json({message:"Method not allowed"})}[n,o]=u.then?(await u)():u,a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[222,357],()=>__webpack_exec__(4164));module.exports=s})();