"use strict";(()=>{var e={};e.id=822,e.ids=[822],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2808:(e,t,i)=>{i.r(t),i.d(t,{config:()=>l,default:()=>d,routeModule:()=>u});var a={};i.r(a),i.d(a,{default:()=>handler});var s=i(1802),n=i(7153),r=i(6249),o=i(4217);async function handler(e,t){let{id:i}=e.query;if("GET"===e.method)try{let{data:e,error:a}=await o.O.from("client_validations").select(`
          *,
          instance:workflow_instances(
            *,
            workflow:workflows(
              *,
              steps:workflow_steps(*)
            )
          )
        `).eq("id",i).single();if(a){if("PGRST116"===a.code)return t.status(404).json({message:"Client validation not found"});throw a}if("expired"===e.status||new Date(e.expires_at)<new Date)return"expired"!==e.status&&await o.O.from("client_validations").update({status:"expired"}).eq("id",i),t.status(410).json({message:"Client validation has expired"});return t.status(200).json(e)}catch(e){return console.error("Error fetching client validation:",e),t.status(500).json({message:"Failed to fetch client validation"})}if("POST"===e.method)try{let{data:a,error:s}=await o.O.from("client_validations").select("*").eq("id",i).single();if(s){if("PGRST116"===s.code)return t.status(404).json({message:"Client validation not found"});throw s}if("expired"===a.status||new Date(a.expires_at)<new Date)return t.status(410).json({message:"Client validation has expired"});if("completed"===a.status)return t.status(409).json({message:"Client validation already completed"});let{files:n}=e.body,r=new Date().toISOString(),{error:d}=await o.O.from("client_validations").update({status:"completed",completed_at:r,uploaded_files:n||[]}).eq("id",i);if(d)throw d;let{error:l}=await o.O.from("step_executions").insert({instance_id:a.instance_id,step_id:a.step_id,started_at:a.created_at,completed_at:r,status:"completed",output:JSON.stringify({files:n||[]}),input_data:{}});if(l)throw l;let u=new Date(a.created_at).getTime(),c=new Date(r).getTime(),p=c-u,{data:_}=await o.O.from("workflow_instances").select("client_wait_time_ms, current_step_index").eq("id",a.instance_id).single();if(_){let e=_.client_wait_time_ms||0;await o.O.from("workflow_instances").update({client_wait_time_ms:e+p,current_step_index:_.current_step_index+1}).eq("id",a.instance_id)}return t.status(200).json({message:"Client validation completed successfully",waitTime:p})}catch(e){return console.error("Error submitting client validation:",e),t.status(500).json({message:"Failed to submit client validation"})}return t.status(405).json({message:"Method not allowed"})}let d=(0,r.l)(a,"default"),l=(0,r.l)(a,"config"),u=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/client-validations/[id]",pathname:"/api/client-validations/[id]",bundlePath:"",filename:""},userland:a})},4217:(e,t,i)=>{i.d(t,{O:()=>r});let a=require("@supabase/supabase-js"),s="https://rpudkaqdoguytyweytww.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdWRrYXFkb2d1eXR5d2V5dHd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNDI3NTMsImV4cCI6MjA2MzcxODc1M30.GWu-jUQXMU94kTuGx9aK5aG_xNVjJFq9lbrcLUW8HBA";if(!s||!n)throw Error("Missing Supabase environment variables");let r=(0,a.createClient)(s,n,{auth:{persistSession:!1,autoRefreshToken:!1},global:{fetch:fetch}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),i=t.X(0,[222],()=>__webpack_exec__(2808));module.exports=i})();